{% extends "base.html" %}
{% load static %}

{% block h2 %}Welcome to News Share{% endblock %}

{% block style %}
<link rel="stylesheet" type="text/css" href="{% static 'mainapp/css/pagenation.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'mainapp/css/post_card.css' %}">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap">
{% endblock style %}

{% block content %}
<input id="has_next" hidden value="{{has_next}}"></input>
<div class="container mt-4">
    <!-- Inline Post Creation Form -->
    <div class="card">
        <div class="card-header">
            <h1 class="card-title">SHARE YOUR NEWS!!</h1>
        </div>
        <div class="card-body ">
            <form id="postForm" method="post" action="{% url 'index' %}">
                {% csrf_token %}
                <div class="form-group">
                    <textarea class="form-control" id="post-content" name="content" rows="3" placeholder="What's happening?"></textarea>
                </div>
                <button type="submit" class="btn btn-primary mt-2">Create Post</button>
            </form>
        </div>
        <div class="card-footer text-body-secondary">
            <p></p>
        </div>
    </div>
    
    <!-- Nav Bar -->
    <ul class="nav nav-tabs mt-4">
        <li class="nav-item">
            <a id="all_posts_nav" class="nav-link {% if not request.GET.nav or request.GET.nav == 'posts' %}active{% endif %}" href="?nav=posts">All Posts</a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if request.GET.nav == 'verified' %}active{% endif %}" href="?nav=verified">Verified Posts</a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if request.GET.nav == 'disproven' %}active{% endif %}" href="?nav=disproven">Disproven Posts</a>
        </li>
    </ul>

    <!-- Posts Section -->
    <div id="posts-container" class="mt-4">
        {% include 'mainapp/post/_posts_section.html' %}
    </div>
</div>
{% endblock %}
{% block script %}
<script src="{% static 'mainapp/js/post_card.js' %}"></script>
<script>

$(document).ready(function(){
    let page = 1;
    let loading = false;

    function loadContent(url) {
        if (loading){ console.log("returned"); return;}
        loading = true;

        $.ajax({
            url: url,
            success: function(data) {
                $('#posts-container').append(data.content);
                show_less_more();
                $('#has_next').val(data.has_next)
                loading = false ;               
            },
            error: function() {
                loading = false;
            }
        });
    }

    $(window).scroll(function() {
        if ($(window).scrollTop() + $(window).height() >= $(document).height() - 10) {
            if($('#has_next').val()=='false'){console.log("no more posts");return;}
            else{console.log("loading extra posts")}
            page++;
            var url = '?page=' + page + '&nav=' + $('.nav-link.active').attr('href').split('=')[1];
            loadContent(url);
        }
    });

    $('.nav-link').click(function(e){
            e.preventDefault();
            $('.nav-link').removeClass('active');
            $(this).addClass('active');
            $('#posts-container').empty(); 
            page = 1; // Reset page counter
            var url = $(this).attr('href') + '&page=' + page;
            loading=false;
            loadContent(url);
        });

    function showFlashMessage(message, type) {
        var alertDiv = $('<div class="alert alert-' + type + '" role="alert">' + message + '</div>');
        $('#postForm').prepend(alertDiv);
        setTimeout(function() {
            alertDiv.fadeOut(function() {
                $(this).remove();
            });
        }, 2000);
    }
    
    $('#postForm').submit(function(e){
        e.preventDefault();  // Prevent the default form submission
        $.ajax({
            type: 'POST',
            url: '{% url "create_post" %}',  
            data: $(this).serialize(),
            success: function(response) {
                if (response.success) {
                    // Handle success response (e.g., refresh posts list, show success message)
                    $('#all_posts_nav').click()
                    showFlashMessage("Post created successfully!","success")
                    $('#postForm')[0].reset();  // Reset the form after successful submission
                } else {
                    // Handle error response (e.g., show error message)
                    showFlashMessage(response.error,"danger")
                }
            },
            error: function(xhr, status, error) {
                console.error("Error creating post: ", error);
                showFlashMessage("UnknownError, please try again in a few moments","danger")
            }
        });
    });
});

</script>

{% endblock %}
